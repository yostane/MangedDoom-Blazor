<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BlazorDoom</title>
    <base href="/MangedDoom-Blazor/" />
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/app.css" rel="stylesheet" />
    <link rel="apple-touch-icon" sizes="57x57" href="apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
</head>

<body>
    <app style="width:80%">Loading...</app>
    <div id="fps"></div>
    <div id="install_button" style="visibility: hidden;"></div>
    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">ðŸ—™</a>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>
    <script src="js/renderutils.js"></script>
    <script src="js/audioutils.js"></script>

    <script>
        const upKeys = [];
        const downKeys = [];
        let audioHelper;


        document.body.addEventListener("keydown", function (e) {
            if (e.target.tagName === "INPUT") {
                return true;
            }
            const index = downKeys.indexOf(e.keyCode);
            if (index < 0) {
                downKeys.push(e.keyCode);
            }
            e.preventDefault();
            return false;
        });
        document.body.addEventListener("keyup", function (e) {
            if (e.target.tagName === "INPUT") {
                return true;
            }
            const index = downKeys.indexOf(e.keyCode);
            if (index > -1) {
                downKeys.splice(index, 1);
            }
            upKeys.push(e.keyCode);
            e.preventDefault();
            return false;
        });

        const frameTime = 28;
        let lastFrameTimestamp = -frameTime;
        const fpsElement = document.getElementById("fps");
        const fpsSmoothing = 0.9;
        var fpsMeasure = 0;

        window.gameLoop = function (timestamp) {
            const duration = timestamp - lastFrameTimestamp
            if (duration >= frameTime) {
                // measure from https://stackoverflow.com/a/87333/13782429
                const currentFps = 1000 / duration;
                fpsMeasure = (fpsMeasure * fpsSmoothing) + (currentFps * (1 - fpsSmoothing));
                fpsElement.innerHTML = `FPS: ${(1000 / duration).toFixed(0)}`;
                lastFrameTimestamp = timestamp;
                DotNet.invokeMethod('BlazorDoom', 'GameLoop', downKeys, upKeys);
                upKeys.splice(0, upKeys.length);
            }

            window.requestAnimationFrame(window.gameLoop);
        }

        const sounds = new Map();

        function playSound(samples, sampleRate, identifier, position) {
            //console.log(position);
            if (!audioHelper) {
                return;
            }
            sounds.set(identifier, samples);
            audioHelper.playByteArray(samples, sampleRate);
        }

        function playLoadedSound(identifier, sampleRate, position) {
            if (!audioHelper) {
                return;
            }
            const sound = sounds.get(identifier);
            audioHelper.playByteArray(sound, sampleRate);
        }

        function initAudioHelper() {
            if (!audioHelper) {
                audioHelper = new AudioHelper();
            }
        }

        // Check that service workers are supported
        if ("serviceWorker" in navigator) {
            // Use the window load event to keep the page load performant
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./sw.js");
            });
            let deferredPrompt; // Allows to show the install prompt
            const installButton = document.getElementById("install_button");

            window.addEventListener("beforeinstallprompt", e => {
                console.log("beforeinstallprompt fired");
                // Prevent Chrome 76 and earlier from automatically showing a prompt
                e.preventDefault();
                // Stash the event so it can be triggered later.
                deferredPrompt = e;
                // Show the install button
                installButton.hidden = false;
                installButton.addEventListener("click", installApp);
            });
            function installApp() {
                deferredPrompt.prompt();
                installButton.disabled = true;
                deferredPrompt.userChoice.then(choiceResult => {
                    if (choiceResult.outcome === "accepted") {
                        console.log("PWA setup accepted");
                        installButton.hidden = true;
                    } else {
                        console.log("PWA setup rejected");
                    }
                    installButton.disabled = false;
                    deferredPrompt = null;
                });
            }
            window.addEventListener("appinstalled", evt => {
                console.log("appinstalled fired", evt);
            });
        }
    </script>
</body>

</html>
